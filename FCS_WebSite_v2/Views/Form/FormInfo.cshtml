@{
    Layout = "_Layout";
}

<head>
    <link rel="stylesheet" href="~/css/form/forminfo.css" />
    <script type="text/javascript" src="~/js/tableToExcel.js"></script>
</head>
<body>
    <div>
        <button type="button" class="btn btn-primary" onclick="exportReportToExcel(this)">
            Экспорт в Excel
        </button>
    </div>
    <div class="table-responsive">
        <table id="infoTable" class="table table-striped">
            <thead>
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">Фамилия</th>
                    <th scope="col">Имя</th>
                    <th scope="col">Время</th>
                    @foreach (var content in Model.Item3)
                    {
                        <th scope="col">@(content)</th>
                    }
                </tr>
            </thead>
            <tbody>
                @{
                    int index = 0;
                    // Список отдельных учеников
                    var certainPupil = new[] {
                        new {
                            LastName = "", FirstName = "", Answers = new List<string>(), 
                            Time = DateTime.Now
                        }
                    }.ToList();
                    foreach (var pupilKey in Model.Item1)
                    {
                        // Список всех ответов отдельного ученика
                        List<string> answers = new List<string>();
                        foreach (var pupilInfo in pupilKey)
                        {
                            answers.Add(pupilInfo.Answers);
                        }
                        int stop = 0;
                        foreach (var pupilInfo in pupilKey)
                        {
                            // Тут костыль, т.е. по циклу проходимся 1 раз
                            if (stop == 1)
                            {
                                break;
                            }
                            // Добавляем в список всех учеников нового ученика
                            certainPupil.Add(new
                            {
                                LastName = (string)(pupilInfo.LastName),
                                FirstName = (string)(pupilInfo.FirstName),
                                Answers = answers,
                                Time = (DateTime)(pupilInfo.Time)
                            });
                            stop++;
                        }
                    }

                }
                @foreach (var pupil in certainPupil)
                {
                    if (index != 0)
                    {
                        <tr>
                            <th data-t="n" scope="row">@index</th>
                            <td>@(pupil.LastName)</td>
                            <td>@pupil.FirstName</td>
                            <td>@pupil.Time</td>
                            @foreach (string answer in pupil.Answers)
                            {
                                <td>@answer</td>
                            }
                        </tr>
                    }
                    index++;
                }
            </tbody>
        </table>
    </div>

    <script src="~/js/fileInfo.js">
    </script>
    <script type="text/javascript">
        function exportReportToExcel() {
            let table = document.getElementById("infoTable");
            let formName = "@(Model.Item2)";
            let fileName = formName + '.xlsx';
            TableToExcel.convert(table, {
                name: fileName,
                sheet: {
                    name: 'Sheet 1'
                }
            });
        }
    </script>
</body>
